#!/usr/bin/env bash
# =========================
# Pre-Push Git Hook
# =========================
# Runs quality checks before pushing to remote
# This helps catch issues early and maintain code quality

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo ""
echo -e "${BLUE}üîç Running pre-push quality checks...${NC}"
echo ""

# Change to repository root
cd "$(git rev-parse --show-toplevel)"

# Track if any checks fail
CHECKS_FAILED=0

# Function to run a check and track failures
run_check() {
    local name="$1"
    local command="$2"
    
    echo -e "${BLUE}‚ñ∂ Running: ${name}${NC}"
    
    if eval "$command"; then
        echo -e "${GREEN}‚úì ${name} passed${NC}"
        echo ""
        return 0
    else
        echo -e "${RED}‚úó ${name} failed${NC}"
        echo ""
        CHECKS_FAILED=1
        return 1
    fi
}

# Ensure dependencies are installed before running checks
if [ ! -d "node_modules" ] || [ ! -d "node_modules/.bin" ]; then
    echo -e "${BLUE}üì¶ Installing dependencies (node_modules incomplete)...${NC}"
    npm install
    echo ""
fi

# Run formatting (auto-fix)
run_check "Format" "npm run lint -- --fix"

# Run ESLint
run_check "ESLint" "npm run lint"

# Run TypeScript type checking
run_check "TypeScript" "npx tsc --noEmit"

# Check results
if [ $CHECKS_FAILED -eq 0 ]; then
    echo -e "${GREEN}‚úÖ All pre-push checks passed! Pushing...${NC}"
    echo ""
    exit 0
else
    echo -e "${RED}‚ùå Pre-push checks failed!${NC}"
    echo ""
    echo -e "${YELLOW}Fix the issues above before pushing.${NC}"
    echo ""
    echo "Quick fixes:"
    echo "  ‚Ä¢ Run: make lint-fix      (auto-fix linting)"
    echo "  ‚Ä¢ Run: make type-check    (check types)"
    echo "  ‚Ä¢ Run: make preflight     (run all checks)"
    echo ""
    echo "To skip this hook (not recommended):"
    echo "  git push --no-verify"
    echo ""
    exit 1
fi

